@model CarRentalManagementSystem.Models.Booking

@{
    ViewData["Title"] = "Book Car";
    var car = ViewBag.Car as CarRentalManagementSystem.Models.Car;
}

<h2 class="mb-4">Book Car</h2>

@if (car == null)
{
    <div class="alert alert-danger">Car not found or unavailable.</div>
}
else
{
    <div class="card shadow-lg mb-4" style="max-width: 700px;">
        <div class="row g-0">
            <div class="col-md-4">
                @if (!string.IsNullOrEmpty(car.ImageUrl))
                {
                    <img src="@car.ImageUrl" class="img-fluid rounded-start" alt="@car.CarName" />
                }
                else
                {
                    <div class="text-muted p-3">No Image</div>
                }
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <h4 class="card-title">@car.CarName (@car.CarModel)</h4>
                    <p class="card-text"><strong>Daily Rate:</strong> @car.DailyRate.ToString("C")</p>
                    <p class="card-text"><strong>Status:</strong> 
                        @(car.IsAvailable ? "Available" : "Not Available")
                    </p>
                    <p id="totalCost" class="text-success fw-bold"></p>
                </div>
            </div>
        </div>
    </div>

    @if (!car.IsAvailable)
    {
        <div class="alert alert-warning">This car is currently unavailable.</div>
    }
    else
    {
        <form asp-action="BookNow" method="post" class="shadow p-4 rounded bg-light" style="max-width: 600px;">
            <input type="hidden" asp-for="CarID" />

            <div class="mb-3">
                <label asp-for="PickupDate" class="form-label">Pickup Date</label>
                <input asp-for="PickupDate" class="form-control" type="date" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                <span asp-validation-for="PickupDate" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="ReturnDate" class="form-label">Return Date</label>
                <input asp-for="ReturnDate" class="form-control" type="date" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                <span asp-validation-for="ReturnDate" class="text-danger"></span>
            </div>

            <button type="submit" class="btn btn-primary">Confirm Booking</button>
            <a asp-action="Index" asp-controller="Car" class="btn btn-secondary">Cancel</a>
        </form>

        <script>
            const dailyRate = @car.DailyRate;
            const pickup = document.querySelector('[name="PickupDate"]');
            const drop = document.querySelector('[name="ReturnDate"]');
            const totalCost = document.getElementById('totalCost');

            function updateCost() {
                if (!pickup.value || !drop.value) return;
                const start = new Date(pickup.value);
                const end = new Date(drop.value);
                let days = (end - start) / (1000 * 60 * 60 * 24);
                days = days <= 0 ? 1 : days;
                totalCost.textContent = "Estimated Total: $" + (days * dailyRate).toFixed(2);
            }

            pickup.addEventListener('change', updateCost);
            drop.addEventListener('change', updateCost);
        </script>
    }
}
